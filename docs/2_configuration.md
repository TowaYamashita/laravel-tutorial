## チュートリアルのURL

https://laravel.com/docs/9.x/configuration

## 環境構成

## 環境変数の種類

|読み取る対象|読み取る方法|例|
|:--|:--|:--|
|APP_ENV|App::environment()|`App::environment(['local','staging])`|
|.env|env()|`env('APP_DEBUG', false)`|
|confg/app.php|config()|`config('app.timezone', 'Asia/Seoul')`|

- 基本的にはすべて文字列として解釈される
  - trueやfalseなどのboolean型などの予約値が存在する
  - 文字列の中にスペースが含まれる場合は、ダブルクオーテーションで囲む必要がある

### 現在の環境の取得方法

- APP_ENV によってアプリケーション環境が決定される
- APP_ENVの値は、`App::environment()` でアクセスできる
- `App::environment()` にアプリケーション環境を文字列で与えることによって、現在の環境が引数の環境と一致した場合に、trueが返ってくる
- 例: アプリケーション環境が staging の場合、 `App::environment('local')` の実行結果はfalse
- 例: アプリケーション環境が staging の場合、 `App::environment(['local','staging])` の実行結果はtrue

### 環境変数の取得方法

- env関数を使用して .envファイルに記載されている環境変数を取得する
- env関数の第一引数には、環境変数のキーを指定する
- env関数の第二引数には、第一引数に指定したキーの環境変数が存在しない場合に使用する値を指定する
- 例: `'debug' => env('APP_DEBUG', false),`

### コンフィグの取得方法

- config関数を使用して、config/app.php に記載されているコンフィグを取得できる
- config関数の第一引数には、コンフィグのキーを指定する
- config関数の第二引数には、第一引数に指定したキーのコンフィグが存在しない場合に使用する値を指定する
- 例: `$value = config('app.timezone', 'Asia/Seoul');`
- config関数に配列を渡すことでコンフィグを設定できる
- 例: `config(['app.timezone' => 'America/Chicago']);`

- `php artisan config:cache` で複数のコンフィグファイルを1つにまとめてパフォーマンスを向上させることができる
> 注意: 設定ファイルがキャッシュされることで、.envファイルがロードされなくなり、env関数の呼び出しはすべてnullを返す


### 環境ファイルのセキュリティ

- .envファイルをソース管理リポジトリへコミットすることはセキュリティリスク上非推奨である
- ソース管理リポジトリへコミットする場合は、暗号化を推奨する

#### 暗号化

- `php artisan env:encrypt` で暗号化された環境ファイル(.env.encrypted)を生成できる
- 暗号化を行った際に復号用のkeyが表示されるため、これをパスワードマネージャーなどに保存しておく
- 復号用のkeyは暗号化する際にLaravelが使用している暗号の種類と長さが一致する文字列であれば自由に設定できる
- 環境に応じて.envファイルを分けている場合は、どの.envファイルを暗号化するかを指定する必要がある
  - 例: staging環境の環境ファイルのみ暗号化する場合は、`php artisan env:encrypt --env=staging` を実行する

#### 復号化

- `php artisan env:decrypt` で復号化された環境ファイル(.env)を生成できる
  - 環境変数の `LARAVEL_ENV_ENCRYPTION_KEY` または 復号コマンドのkeyオプションに復号用のkeyを指定する必要がある
- 環境に応じて.envファイルを分けている場合は、どの.envファイルを復号化するかを指定する必要がある
  - 例: staging環境の環境ファイルのみ復号化する場合は、`php artisan env:decrypt --env=staging` を実行する

### 追加の環境ファイル

- 環境に応じて.envファイルを作成することができる
- APP_ENVまたはCLIで外部から環境を指定されていれば、それに該当する.envファイルを探してロードする
- 該当する.envファイルが見つからなければ.envファイルがロードされる

## 本番環境以外のモード

### デバッグモード

- エラー発生時に表示されるデータが開発者フレンドリーになります(スタックトレースの表示など)
- 本番環境では必ずデバッグモードをオフにすること
  - オフにしないと機密性の高いコンフィグが外部に漏れる恐れがある

## メンテナンスモード

- アプリケーションに対するあらゆるリクエストに対してカスタムビューを表示できる


### メンテンナンスモードを有効化
- `php artisan down` 
  - メンテナンスモードを有効にできる
- `php artisan down --refresh=15` 
  - 15秒間隔でページを更新するようにできる
- `php artisan down --retry=60` 
  - 60秒間隔でページを更新するようにできる(ブラウザが無視するため非推奨)
- `php artisan down --secret="1630542a-246b-4b66-afa1-dd72a4c43515"`
  - 特定のトークンをつけてURLにアクセスするとメンテナンスモードをパイパスできる
  - 例: `https://example.com/1630542a-246b-4b66-afa1-dd72a4c43515` にアクセスすることでメンテナンスモードをバイパスして通常通りアプリケーションを閲覧できる
- `php artisan down --render="errors::503"`
  - メンテナンスモードが有効である場合に表示する画面を事前にレンダリングさせる
  - メンテナンスモードが有効になってから更新されるまでの間にユーザがアプリケーションにアクセスした場合に、エラーを吐く可能性を潰すため
- `php artisan down --redirect=/`
  - メンテンナンスモード時に特定のURLへリダイレクトさせる

### メンテナンスモードを無効化
- `php artisan up` でメンテナンスモードを無効にできる

### メンテナンスモードとキュー

- メンテンナンスモード中にキューに投入されたジョブは処理されず、メンテンナンスモードが終了し終わったら処理が再開される

### メンテナンスモードの代替手段

- ダウンタイムが必要になるため、ゼロダウンタイムのデプロイが要求される場合は以下で代替できないか検討する
  - Laravel Vapor
  - Envoyer